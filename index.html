<!DOCTYPE html>
<html>
  <head>
  <meta http-equiv="Content-Security-Policy"
      content="default-src 'self' gap://ready file://* *; img-src * 'self' data:; style-src 'self' 'unsafe-inline' 'unsafe-eval' https://*.googleapis.com; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://*.googleapis.com;">
  <!--  <meta http-equiv="Content-Security-Policy"
      content="img-src * 'self' data:; default-src *; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://maps.googleapis.com https://fonts.googleapis.com">-->
  	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="viewport"   content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>SMonBarcode</title>
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<script type="text/javascript" charset="utf-8" src="cordova.js"></script>

<link href="assets/css/style.css" rel="stylesheet">
<link href="assets/css/icomoon.css" rel="stylesheet">
<link href="assets/css/bootstrap.css" rel="stylesheet">
<link href="assets/css/bootstrap.min.css" rel="stylesheet">
<link href="assets/css/bootstrap-grid.css" rel="stylesheet">
<link href="assets/css/bootstrap-grid.min.css" rel="stylesheet">
<link href="assets/css/bootstrap-reboot.css" rel="stylesheet">
<link href="assets/css/bootstrap-reboot.min.css" rel="stylesheet">
<script src="assets/js/jquery-3.3.1.min.js"></script>
<script src="assets/js/bootstrap.js"></script>
<script src="assets/js/bootstrap.min.js"></script>
<script src="assets/js/bootstrap.bundle.js"></script>
<script src="assets/js/bootstrap.bundle.min.js"></script>

<script>


var MyLat;
var MyLong;
var MyAlt;
var MyHead;
var MySpeed;
var MyAcc;
MyLat=41.718287;
MyLong=44.778728;


function onDeviceReady() 
	{
    document.removeEventListener('deviceready', onDeviceReady, false);
	document.addEventListener("backbutton", backKeyDown, true);
	console.log("device ready, getting position");
	navigator.geolocation.getCurrentPosition(onSuccess, onError, {enableHighAccuracy: true,  maximumAge:0});
	console.log("setting watch");
	var opts = { timeout: 5000, enableHighAccuracy: true, maximumAge:0};
	watchID = navigator.geolocation.watchPosition(onSuccess, onError, opts);
	
//	scan_bar_code();
	req_loc_acc();
	req_loc_auth();

	//if (inited==0)
//		{
		inited=1;
		initMap();
		//}



    }
function backKeyDown()
	{
	if (cc("username")!="")
		{
		console.log("back: "+cuser);
		sw("menu_div");
		}
	}

var GPSFound=0;
var inited=0;

function onSuccess(position) 
	{
	console.log("on GPS success");
	document.getElementById("infodiv").innerHTML="<font color=green><center>თქვენი ლოკაცია დადგენილია</center></font>";
	GPSFound=1;
	MyLat=position.coords.latitude ;
	MyLong=position.coords.longitude ;
	MyAlt=position.coords.altitude ;
	MyHead=position.coords.heading ;
	MySpeed=position.coords.speed ;
	MyAcc=position.coords.accuracy;

	console.log(MyLat+ " - "+MyLong);
	
if (inited==1)
		{
		var myLatLng = {lat: MyLat, lng: MyLong};
		MyMap.panTo(myLatLng);
		MyMarker.setPosition(myLatLng);

		}

    }

document.addEventListener("deviceready", onDeviceReady, false);

function checkin()
	{
	navigator.geolocation.getCurrentPosition(onSuccess, onError, {enableHighAccuracy: true,  maximumAge:0});

	if (GPSFound==1)
		{
		// mimdinare lokaciaze gegmis kompanies motxovna
		var mdata="unid="+unid+"&reqcmp=1&uname="+cuser+"&lat="+MyLat+"&lng="+MyLong+"&ctype=1";
		sw("wait_div");
		send_data(mdata);

		}
	else
		{
		document.getElementById("infodiv").innerHTML="<font color=red><center>დაელოდოთ ლოკაციის დადგენას</center></font>";
		}
	}

function check_me_in(cmpid)
	{
	if (confirm("დაჩექინება?"))
		{
	
		var d = new Date();
		var curdate=d.getFullYear()+"-"+(d.getMonth()+1)+"-"+d.getDate()+"%20"+d.getHours()+":"+d.getMinutes()+":"+d.getSeconds();
		var nscan=cmpid+"|"+curdate+"|"+MyLat+"|"+MyLong;
		var mdata="unid="+unid+"&uname="+cuser+"&checkin="+nscan;
		sw("wait_div");
		curdata=mdata;
		ajax_send();
	//	send_data(mdata);
		}
	}

function scan_bar_code()
	{
	//alert("scaninng");
	navigator.geolocation.getCurrentPosition(onSuccess, onError, {enableHighAccuracy: true,  maximumAge:0});

	if (GPSFound==1)
		{
		
			cordova.plugins.barcodeScanner.scan(
			  function (result) {
				  add_scan(result.text);
				 // alert("cavikitxe: " + result.text + "\n" +   "formati: " + result.format + "\n");
			  },
			  function (error) {
				  alert("Scanning failed: " + error);
			  },
			  {
				  preferFrontCamera : false, // iOS and Android
				  showFlipCameraButton : false, // iOS and Android
				  showTorchButton : true, // iOS and Android
				  torchOn: false, // Android, launch with the torch switched on (if available)
				  saveHistory: false, // Android, save scan history (default false)
				  prompt : "მიუშვირეთ ბარკოდს", // Android
				  resultDisplayDuration: 300, // Android, display scanned text for X ms. 0 suppresses it entirely, default 1500
				  disableAnimations : true, // iOS
				  disableSuccessBeep: false // iOS and Android
			  }
		   );
		}
	else
		{
		document.getElementById("infodiv").innerHTML="<font color=red><center>დაელოდოთ ლოკაციის დადგენას</center></font>";
		}
	}

function req_locme()
{
	console.log("jus raga");
	console.log("requesting location");
	navigator.geolocation.getCurrentPosition(onSuccess, onError, {enableHighAccuracy: true,  maximumAge:0});
}

//  formats : "QR_CODE,PDF_417", // default: all but PDF_417 and RSS_EXPANDED
//          orientation : "landscape", // Android only (portrait|landscape), default unset so it rotates with the device
var visits="";
function add_scan(barcode)
	{
	//visits=cc("work");
//	var d = new Date();
//	var curdate=d.getFullYear()+"-"+(d.getMonth()+1)+"-"+d.getDate()+"%20"+d.getHours()+":"+d.getMinutes()+":"+d.getSeconds();
//	var nscan=barcode+"|"+curdate+"|"+MyLat+"|"+MyLong;
//	visits+=nscan+",";
//	setc("work",visits);
//	send_visits();

	//var mdata="unid="+unid+"&reqcmp=1&uname="+cuser+"&lat="+MyLat+"&lng="+MyLong+"&ctype=2&barcode="+barcode;
	//sw("wait_div");
	//send_data(mdata);

	var d = new Date();
	var curdate=d.getFullYear()+"-"+(d.getMonth()+1)+"-"+d.getDate()+"%20"+d.getHours()+":"+d.getMinutes()+":"+d.getSeconds();
	var nscan=barcode+"|"+curdate+"|"+MyLat+"|"+MyLong;
	var mdata="unid="+unid+"&uname="+cuser+"&iambarcode=2&checkin="+nscan;
	sw("wait_div");
	curdata=mdata;
	ajax_send();


	}

function send_visits()
	{
	visits=cc("work");
	if (visits!="")
		{
		var mdata="unid="+unid+"&visit=1&uname="+cuser+"&visits="+visits;
		sw("wait_div");
		send_data(mdata);
		}
	}

function setc(mname, mval)
	{
	console.log("set cookie:"+mname+"="+mval+";");
	document.cookie=""+mname+"="+mval+";";
	}


function cc(mname)
	{
	var mycookies = document.cookie;
	var mc= new Array();
	mc=mycookies.split(";");
	var found=false;
	for (i=0;i<mc.length ;i++ )
		{
		mk=mc[i].split("=");
		mk[0]=mk[0].replace(" ","");
		if (mk[0]==mname)
			{
			found=true;
			return mk[1];
			}
		}
	if (found==false)
		{
		return "";
		}
	}

function sw(mscr)
	{

	document.getElementById("login_div").style.display="none";
	document.getElementById("menu_div").style.display="none";
	document.getElementById("wait_div").style.display="none";
	document.getElementById("gegma_div").style.display="none";
	document.getElementById("checkin_div").style.display="none";

	document.getElementById(mscr).style.display="inline";
	}

function logout()
	{
	setc("username","");
	check_user();
	}


var brainhttp;
var b_recv;
if (window.XMLHttpRequest) {brainhttp=new XMLHttpRequest();}
else if (window.ActiveXObject) {brainhttp=new ActiveXObject('Microsoft.XMLHTTP');}
else {alert('Your browser does not support XMLHTTP!');}

var curdata="";
var data_sent=0;
var attempts=0;
brainhttp.onreadystatechange=brain_recv;

var row_time=0;
var sel_row=0;
function mrowdown(rowid)
	{
	row_time=Math.floor(Date.now() / 1000);
	sel_row=rowid;
	console.log("pressed: "+row_time+", selrow: "+sel_row);

	}
function mrow_up()
	{
	console.log("upped: "+row_time+", selrow: "+sel_row+", curtime: "+Math.floor(Date.now() / 1000) );

	if (sel_row>0 && (Math.floor(Date.now() / 1000)-row_time)>2)
		{
		if (confirm("დარწმუნებული ხართ რომ გინდათ მონიშნული კომპანიის წაშლა?"))
			{
				console.log("delete");
			del_cmp(sel_row);
			}
		}
	row_time=0;
	sel_row=0;
	}
function send_data(mdata)
	{
	attempts=0;
	curdata=mdata;
	console.log("sending data: "+curdata);
	data_sent=0;
	ajax_send();
	setTimeout("resend();",5000);
	
	}

function resend()
	{
	if (data_sent==0)
		{
		if (attempts<10)
			{
			attempts++;
			console.log("repeat: "+curdata+ " - "+data_sent);
			ajax_send();
			setTimeout("resend();",5000);
			}
		else
			{
			curdata="";
			data_sent=1;
			check_user();
		
			}
		}
	}
function ajax_send()
	{
	url='https://smartgps.ge/barcode/ajax.php?'+curdata;
	console.log("send data: "+url);
	brainhttp.open('GET',url,true);
	brainhttp.send(null);
	}


function brain_recv()
	{

	if (brainhttp.readyState==4 && brainhttp.status==200)
		{
		b_recv=brainhttp.responseText;
	
		console.log("recv: "+b_recv);
		data_sent=1;
		var a=new Array();
		a=b_recv.split(";");
		if (a[1]=="login")
			{

			if (a[3]!="")
				{
				console.log("logged in");
				console.log(curdata+ " - "+data_sent);
				setc("username",a[3])
				cuser=a[3];
				sw("menu_div");
				document.getElementById("muname").innerHTML=cuser;
				console.log("cookies: "+document.cookie);
				send_visits();
				}
			else
				{
				sw("login_div");
				alert("არასწორი სახელი ან პაროლი");

				}
			}
		else if (a[1]=="visits")
			{

			if (a[2]=="done")
				{
				console.log("visits recieved");
				visits="";
				setc("work","")
				sw("menu_div");
				console.log("cookies: "+document.cookie);
				}
			
			}
		else if (a[1]=="checkin_done")
			{

			if (a[2]=="done")
				{
				console.log("checkin recieved");
				sw("menu_div");
				}
			}
		else if (a[1]=="gegma")
			{
			var c=b_recv.replace(";gegma;","");
			document.getElementById("gegma_div").innerHTML=c;
			console.log("showing gegma");
			sw("gegma_div");
			}
		else if (a[1]=="checkin")
			{
			document.getElementById("checkin_div").innerHTML=a[2];
			sw("checkin_div");
			}
		else if (a[1]=="logout")
			{
			logout()
			}
//		document.getElementById("infodiv").innerHTML=b_recv+"<br>"+		document.getElementById("infodiv").innerHTML;


		}
	}


function login()
	{
	var mdata="unid="+unid+"&login=1&uname="+document.getElementById("uname").value+"&upass="+document.getElementById("upass").value;
	sw("wait_div");
	send_data(mdata);
	}

function show_plan()
	{
	var mdata="unid="+unid+"&gegma=1&uname="+cuser;
	sw("wait_div");
	send_data(mdata);
	}


function del_cmp(cmpid)
	{
	if (confirm("დარწმუნებული ხართ რომ გინდათ მონიშნული კომპანიის წაშლა?"))
		{
		console.log("delcmp: "+cmpid);
		var mdata="unid="+unid+"&gegma=1&uname="+cuser+"&delcmp="+cmpid;
		sw("wait_div");
		send_data(mdata);
		}
	}
</script>

  </head>
  <style>
	body {color:black; margin:0px; padding:0px;}
	a {text-decoration:none; color:blue;}
  </style>
  <body style='padding:0; border:0; margin:0; color:black; background-color:white; '>

	<div class="container-fluid headerbg fixed-top">
		<div class="row header">
			<!--<div class="menuBtn">
				<a class="menu" href="#"><i class="icon-menu5"></i></a>
			</div>-->
			<div class="headerTitle">
				სმარტ ჯიპიესი
			</div>
		</div>
	</div>



<div id='login_div' style='position:absolute; top:60px;left:0px; width:100%;'>
<Br><br><br><br><br>
	<center>
	<input type='text' id='uname' name='uname' value='' placeholder='მომხ. სახელი'><br>
	<input type='password' id='upass' name='upass' value='' placeholder='პაროლი'><br>
	<input type='button' value='შესვლა' onclick="login()";>
	</center>

</div>

<div id='wait_div' style="display:none; position:absolute; top:55px;left:0px;">
<br><br><br><br><br><br><br><br>
<center>მოქმედება წარმატებით შესრულდა<br>მიმდინარეობს მონაცემების გადაგზავნა</center>
</div>


<div class="container-fluid h-100" style="height: 100%; padding-top: 58px; display:none;"   id='menu_div' >
	<div class="d-flex flex-column h-100 justify-content-between align-items-stretch" style="height: 100%;" >
<br>
		 <div id="mymap" style='height:150px;'></div>
		<div id='infodiv'></div>


   
		<table width=100%>
		<tr>
		<Td><a class="test" href="Javascript: scan_bar_code();">
			<div class="d-flex align-items-center h-50 justify-content-center">
				<div class="menuItem">
					<img src="assets/img/camera.svg" width="64"><br/>
					სკანირება
				</div>
			</div>
		</a></td>
		<Td><a class="test" href="Javascript: checkin();">
			<div class="d-flex align-items-center h-50 justify-content-center">
				<div class="menuItem">
					<img src="assets/img/camera.svg" width="64"><br/>
					Check in
				</div>
			</div>
		</a></td>
		<Td>
		<a class="test" href="Javascript: show_plan();">
			<div class="d-flex align-items-center h-50 justify-content-center">
				<div class="menuItem">
					<img src="assets/img/route.svg" width="64"><br/>
					რუტი
				</div>
			</div>
		</a></td>
		</tr></table>
<!--
<a href='Javascript: req_locme();'>reqlocme</a><BR>
		 <p>Current Location Mode: <span id="curlocmode"></span></p>

        <div><input type='button' id="location-settings" onclick='open_loc_settings();' value='Open Location settings'></div>

        <div><input type='button' id="request-authorization" onclick="req_loc_auth();" value='Request Location Authorization'></div>
		<div><input type='button' id="request-accuracy"  onclick="req_loc_acc();" value='Request Location Accuracy' ></div>
		 <Br><br>

-->

		<p align=right>მოგასლმებით: <span id='muname'></span>, <a href="Javascript: logout();">გამოსვლა</a></p>
	</div>
</div>



<div id='gegma_div'  class="container content" style="display:none; padding:15px; position:absolute; top:0px;left:0px; ">

</div>



<div id='checkin_div'  class="container content" style="display:none; padding:15px; position:absolute; top:0px;left:0px;">

</div>


 <script>

 var MyMap;
 var MyMarker;

	function initMap() 
		{
		if (MyLat<30)
			{
			MyLat=41.718287;
			MyLong=44.778728;
			}
		var myLatLng = {lat: MyLat, lng: MyLong};
 
		MyMap = new google.maps.Map(document.getElementById('mymap'), {
          zoom: 15,
          center: myLatLng,
			  zIndex:70,
			fullscreenControl: false,
			streetViewControl: false,
			mapTypeControl: false,
			disableDefaultUI: true
        });

		MyMarker = new google.maps.Marker({
			  position: myLatLng,
			  map: MyMap,
			});

	
      }

//&callback=initMap
    </script>
<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAFY47FE__z9AvRLBoYG0T2XeOTiHdwzOQ"></script>


</body>

<script>
console.log("cookies: "+document.cookie);
var cuser="";
var unid="";
if (cc("unid")=="")
	{
	setc("unid",parseInt(Math.random()*10000000));
	}
else
	{
	unid=cc("unid");
	}

function check_user()
	{

	if (cc("username")=="")
		{
		sw("login_div");
		}
	else
		{	
		cuser=cc("username");
		sw("menu_div");
		document.getElementById("muname").innerHTML=cuser;
		send_visits();
		}
	}

check_user();

//document.getElementById("infodiv").innerHTML=document.cookie;



function onRequestSuccess( success)
	{
    console.log("Successfully requested accuracy "+success.message);
	var k=success.message;
	var b=k.split("agreed");
	if (b.length>1)
		{
		// aplikaciis restarti tu motxovna gaxda sachiro da userma ok utxra
		location.reload();
		}
    }

function onRequestFailure(error)
	{
    console.log("Accuracy request failed: error code="+error.code+"; error message="+error.message);
	}

function req_loc_acc()
	{
	var accuracy = 3;
	var accuracyName  = "High Accuracy";
	console.log("requesting acc");
	cordova.plugins.locationAccuracy.request(onRequestSuccess, onRequestFailure, cordova.plugins.locationAccuracy.REQUEST_PRIORITY_HIGH_ACCURACY);
	}

function req_loc_auth()
	{
	console.log("requesting auth");
	cordova.plugins.diagnostic.isLocationAuthorized(function (authorized) {
            if(!authorized)
				{

                cordova.plugins.diagnostic.requestLocationAuthorization(function (status) {console.log("Requested location authorization: authorization was " + status);}, errorFunction, cordova.plugins.diagnostic.locationAuthorizationMode.ALWAYS);
				}
			else
				{
                errorFunction(1);
	            }
		}, errorFunction);
	}


function checkState()
	{
    console.log("Checking location state...");

    function evaluateMode(mode)
		{
        document.getElementById("curlocmode").innerHTML=mode; 
	    }
    cordova.plugins.diagnostic.getLocationMode(evaluateMode, onError);
	}

function onError(error)
	{
	console.error(error);

	}

function errorFunction(error)
	{
	console.error(error);
	if (error!=1)
		{
		req_loc_acc();
		req_loc_auth();
		}
	}

function open_loc_settings()
	{
	cordova.plugins.diagnostic.switchToLocationSettings();
	}
</script>

</html>
