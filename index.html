<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Security-Policy" content="default-src *; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline' 'unsafe-eval'">
  	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="viewport"   content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>SMonBarcode</title>
<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<script type="text/javascript" charset="utf-8" src="cordova.js"></script>

<link href="assets/css/style.css" rel="stylesheet">
<link href="assets/css/icomoon.css" rel="stylesheet">
<link href="assets/css/bootstrap.css" rel="stylesheet">
<link href="assets/css/bootstrap.min.css" rel="stylesheet">
<link href="assets/css/bootstrap-grid.css" rel="stylesheet">
<link href="assets/css/bootstrap-grid.min.css" rel="stylesheet">
<link href="assets/css/bootstrap-reboot.css" rel="stylesheet">
<link href="assets/css/bootstrap-reboot.min.css" rel="stylesheet">

<script src="assets/js/bootstrap.js"></script>
<script src="assets/js/bootstrap.min.js"></script>
<script src="assets/js/bootstrap.bundle.js"></script>
<script src="assets/js/bootstrap.bundle.min.js"></script>

<script>


var MyLat;
var MyLong;
var MyAlt;
var MyHead;
var MySpeed;
var MyAcc;

function onDeviceReady() 
	{
    document.removeEventListener('deviceready', onDeviceReady, false);

	console.log("device ready, getting position");
	navigator.geolocation.getCurrentPosition(onSuccess, onError, {enableHighAccuracy: true,  maximumAge:0});
	var opts = { timeout: 5000, enableHighAccuracy: true, maximumAge:0};
	watchID = navigator.geolocation.watchPosition(onSuccess, onError, opts);
	
//	scan_bar_code();

    }


function onSuccess(position) 
	{
	console.log("on GPS success");

	MyLat=position.coords.latitude ;
	MyLong=position.coords.longitude ;
	MyAlt=position.coords.altitude ;
	MyHead=position.coords.heading ;
	MySpeed=position.coords.speed ;
	MyAcc=position.coords.accuracy;

	console.log(MyLat+ " - "+MyLong);



    }

document.addEventListener("deviceready", onDeviceReady, false);

function onError()
	{
//		onDeviceReady() ;
//	alert("error");
	}

function scan_bar_code()
{
	//alert("scaninng");

	cordova.plugins.barcodeScanner.scan(
      function (result) {
		  add_scan(result.text);
         // alert("cavikitxe: " + result.text + "\n" +   "formati: " + result.format + "\n");
      },
      function (error) {
          alert("Scanning failed: " + error);
      },
      {
          preferFrontCamera : false, // iOS and Android
          showFlipCameraButton : false, // iOS and Android
          showTorchButton : true, // iOS and Android
          torchOn: false, // Android, launch with the torch switched on (if available)
          saveHistory: false, // Android, save scan history (default false)
          prompt : "მიუშვირეთ ბარკოდს", // Android
          resultDisplayDuration: 300, // Android, display scanned text for X ms. 0 suppresses it entirely, default 1500
          disableAnimations : true, // iOS
          disableSuccessBeep: false // iOS and Android
      }
   );
}

//  formats : "QR_CODE,PDF_417", // default: all but PDF_417 and RSS_EXPANDED
//          orientation : "landscape", // Android only (portrait|landscape), default unset so it rotates with the device
var visits="";
function add_scan(barcode)
	{
	visits=cc("work");
	var d = new Date();
	var curdate=d.getFullYear()+"-"+(d.getMonth()+1)+"-"+d.getDate()+" "+d.getHours()+":"+d.getMinutes()+":"+d.getSeconds();

	var nscan=barcode+"|"+curdate;
	visits+=nscan+",";
	setc("work",visits);
	send_visits();
	}

function send_visits()
	{
	visits=cc("work");
	if (visits!="")
		{
		var mdata="unid="+unid+"&visit=1&uname="+cuser+"&visits="+visits;
		sw("wait_div");
		send_data(mdata);
		}
	}

function setc(mname, mval)
	{
	console.log("set cookie:"+mname+"="+mval+";");
	document.cookie=""+mname+"="+mval+";";
	}


function cc(mname)
	{
	var mycookies = document.cookie;
	var mc= new Array();
	mc=mycookies.split(";");
	var found=false;
	for (i=0;i<mc.length ;i++ )
		{
		mk=mc[i].split("=");
		mk[0]=mk[0].replace(" ","");
		if (mk[0]==mname)
			{
			found=true;
			return mk[1];
			}
		}
	if (found==false)
		{
		return "";
		}
	}

function sw(mscr)
	{

	document.getElementById("login_div").style.display="none";
	document.getElementById("menu_div").style.display="none";
	document.getElementById("wait_div").style.display="none";
	document.getElementById("gegma_div").style.display="none";

	document.getElementById(mscr).style.display="inline";
	}

function logout()
	{
	setc("username","");
	check_user();
	}


var brainhttp;
var b_recv;
if (window.XMLHttpRequest) {brainhttp=new XMLHttpRequest();}
else if (window.ActiveXObject) {brainhttp=new ActiveXObject('Microsoft.XMLHTTP');}
else {alert('Your browser does not support XMLHTTP!');}

var curdata="";
var data_sent=0;
var attempts=0;
brainhttp.onreadystatechange=brain_recv;

function send_data(mdata)
	{
	attempts=0;
	curdata=mdata;
	console.log("sending data: "+curdata);
	data_sent=0;
	ajax_send();
	setTimeout("resend();",3000);
	
	}

function resend()
	{
	if (data_sent==0)
		{
		if (attempts<3)
			{
			attempts++;
			console.log("repeat: "+curdata+ " - "+data_sent);
			ajax_send();
			setTimeout("resend();",3000);
			}
		else
			{
			curdata="";
			data_sent=1;
			check_user();
		
			}
		}
	}
function ajax_send()
	{
	url='https://smartgps.ge/barcode/ajax.php?'+curdata;
	console.log("send data: "+url);
	brainhttp.open('GET',url,true);
	brainhttp.send(null);
	}


function brain_recv()
	{

	if (brainhttp.readyState==4 && brainhttp.status==200)
		{
		b_recv=brainhttp.responseText;
	
		console.log("recv: "+b_recv);
		data_sent=1;
		var a=new Array();
		a=b_recv.split(";");
		if (a[1]=="login")
			{

			if (a[3]!="")
				{
				console.log("logged in");
				console.log(curdata+ " - "+data_sent);
				setc("username",a[3])
				cuser=a[3];
				sw("menu_div");
				document.getElementById("muname").innerHTML=cuser;
				console.log("cookies: "+document.cookie);
				send_visits();
				}
			else
				{
				sw("login_div");
				alert("არასწორი სახელი ან პაროლი");

				}
			}
		else if (a[1]=="visits")
			{

			if (a[2]=="done")
				{
				console.log("visits recieved");
				visits="";
				setc("work","")
				sw("menu_div");
				console.log("cookies: "+document.cookie);
				}
			
			}
		else if (a[1]=="gegma")
			{
			document.getElementById("gegma_div").innerHTML=a[2];
			sw("gegma_div");
			}
//		document.getElementById("infodiv").innerHTML=b_recv+"<br>"+		document.getElementById("infodiv").innerHTML;


		}
	}


function login()
	{
	var mdata="unid="+unid+"&login=1&uname="+document.getElementById("uname").value+"&upass="+document.getElementById("upass").value;
	sw("wait_div");
	send_data(mdata);
	}

function show_plan()
	{
	var mdata="unid="+unid+"&gegma=1&uname="+cuser;
	sw("wait_div");
	send_data(mdata);
	}
</script>

  </head>
  <style>
	body {color:black; margin:0px; padding:0px;}
	a {text-decoration:none; color:blue;}
  </style>
  <body style='padding:0; border:0; margin:0; color:black; background-color:white; '>

	<div class="container-fluid headerbg fixed-top">
		<div class="row header">
			<div class="menuBtn">
				<a class="menu" href="#"><i class="icon-menu5"></i></a>
			</div>
			<div class="headerTitle">
				სმარტ ჯიპიესი
			</div>
		</div>
	</div>


<div id='infodiv'></div>
<div id='login_div'>
	<center>
	<input type='text' id='uname' name='uname' value='' placeholder='სახელი'><br>
	<input type='password' id='upass' name='upass' value='' placeholder='პაროლი'><br>
	<input type='button' value='შესვლა' onclick="login()";>
	</center>

</div>

<div id='wait_div' style="display:none;">
	 მიმდინარეობს მონაცემების გადაგზავნა
</div>


<div class="container-fluid h-100" style="height: 100%; padding-top: 58px; display:none;"   id='menu_div' >
	<div class="d-flex flex-column h-100 justify-content-between align-items-stretch" style="height: 100%;" >
		<div class="h-50"><a class="test" href="Javascript: scan_bar_code();">
			<div class="d-flex align-items-center h-100 justify-content-center">
				<div class="menuItem">
					<img src="assets/img/camera.svg" width="64"><br/>
					სკანირება
				</div>
			</div>
		</a></div>
		<div class="h-50"><a class="test" href="Javascript: show_plan();">
			<div class="d-flex align-items-center h-100 justify-content-center">
				<div class="menuItem">
					<img src="assets/img/route.svg" width="64"><br/>
					რუტი
				</div>
			</div>
		</a></div>
		<p align=right>მოგასლმებით: <span id='muname'></span>, <a href="Javascript: logout();">გამოსვლა</a></p>
	</div>
</div>



<div id='gegma_div' style="display:none;">

</div>
</body>

<script>
console.log("cookies: "+document.cookie);
var cuser="";
var unid="";
if (cc("unid")=="")
	{
	setc("unid",parseInt(Math.random()*10000000));
	}
else
	{
	unid=cc("unid");
	}

function check_user()
	{

	if (cc("username")=="")
		{
		sw("login_div");
		}
	else
		{	
		cuser=cc("username");
		sw("menu_div");
		document.getElementById("muname").innerHTML=cuser;
		send_visits();
		}
	}

check_user();

//document.getElementById("infodiv").innerHTML=document.cookie;
</script>

</html>
